name: Build for Release (Windows & Linux)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      nexttrace_version:
        description: 'Nexttrace version (e.g., v0.3.3, leave empty to use latest)'
        required: false
        default: ''
      use_latest:
        description: 'Use latest nexttrace version'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: 
      contents: write

    strategy:
      matrix:
        runtime: [win-x64, linux-x64, linux-arm64, win-arm64]
        include:
          - runtime: win-x64
            artifact_path: ./bin/Wpf/Release/net48/win-x64
            self_contained: "--no-self-contained"
            framework: net48
            nt_file: nexttrace_windows_amd64.exe
            nt_fn: nexttrace.exe
            archive_command: "zip -r"
            archive_extension: zip
          - runtime: win-arm64
            artifact_path: ./bin/Wpf/Release/net481/win-arm64
            self_contained: "--no-self-contained"
            framework: net481
            nt_file: nexttrace_windows_arm64.exe
            nt_fn: nexttrace.exe
            archive_command: "zip -r"
            archive_extension: zip
          - runtime: linux-x64
            artifact_path: ./bin/Gtk/Release/net8.0/linux-x64
            self_contained: "--self-contained"
            framework: net8.0
            nt_file: nexttrace_linux_amd64
            nt_fn: nexttrace
            archive_command: "tar -cvzf"
            archive_extension: tar.gz
          - runtime: linux-arm64
            artifact_path: ./bin/Gtk/Release/net8.0/linux-arm64
            self_contained: "--self-contained"
            framework: net8.0
            nt_file: nexttrace_linux_arm64
            nt_fn: nexttrace
            archive_command: "tar -cvzf"
            archive_extension: tar.gz

    env:
        NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8

    - name: NuGet Restore
      run: |
          dotnet restore OpenTrace.csproj

    - name: Build
      run: dotnet build OpenTrace.csproj --runtime ${{ matrix.runtime }} --configuration Release ${{ matrix.self_contained }} -f ${{ matrix.framework }}

    - name: Fetch Nexttrace Version
      run: |
        if [ -n "${{ github.event.inputs.nexttrace_version }}" ]; then
          echo "ntver=${{ github.event.inputs.nexttrace_version }}" >> $GITHUB_ENV
        else
          release="${{ github.event.release.body }} "
          echo "ntver=$(echo $release | grep -E -o nexttrace_version:.\*? | cut -d':' -f2)" >> $GITHUB_ENV
        fi
    
    - name: Download Nexttrace
      uses: robinraju/release-downloader@v1.8
      with: 
        repository: nxtrace/NTrace-V1
        fileName: ${{ matrix.nt_file }}
        latest: ${{ (github.event.inputs.use_latest == 'true' || (env.ntver == '' && github.event.inputs.nexttrace_version == '')) && true || false }}
        tag: ${{ env.ntver }}
        token: ${{ secrets.GITHUB_TOKEN }}
        out-file-path: ${{ matrix.artifact_path }}

    - name: Copy WinDivert files (Windows only)
      if: matrix.runtime == 'win-x64'
      run: |
        cp ${{ github.workspace }}/.github/WinDivert.dll ${{ matrix.artifact_path }}/
        cp ${{ github.workspace }}/.github/WinDivert64.sys ${{ matrix.artifact_path }}/

    - name: Package
      run: |
        cd ${{ matrix.artifact_path }}
        mv ./nexttrace_* ./${{ matrix.nt_fn }}
        chmod +x ./${{ matrix.nt_fn }}
        ${{ matrix.archive_command }} ${{ github.workspace }}/${{ matrix.runtime }}.${{ matrix.archive_extension }} ${{ matrix.pack_target == '' && '.' || matrix.pack_target }}

    - name: Upload to Release (when triggered by release event)
      if: github.event_name == 'release'
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ${{ matrix.runtime }}.${{ matrix.archive_extension }}
        asset_name: ${{ matrix.runtime }}.${{ matrix.archive_extension }}
        tag: ${{ github.ref }}
    
    - name: Upload Artifact (when manually triggered)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.runtime }}
        path: ${{ matrix.runtime }}.${{ matrix.archive_extension }}
