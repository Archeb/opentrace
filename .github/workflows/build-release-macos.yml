name: Build for Release (macOS)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      nexttrace_version:
        description: 'Nexttrace version'
        required: false
        default: ''

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - runtime: osx-x64
            nt_file: nexttrace_darwin_amd64
          - runtime: osx-arm64
            nt_file: nexttrace_darwin_arm64

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8

    - name: Import Certificates
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
        p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}

    - name: Store Notarization Credentials
      run: |
        xcrun notarytool store-credentials "AC_PASSWORD" \
          --apple-id "${{ secrets.APPLE_ID }}" \
          --team-id "${{ secrets.APPLE_TEAM_ID }}" \
          --password "${{ secrets.MACOS_NOTARIZATION_PWD }}"

    - name: Build and Bundle
      run: |
        dotnet publish OpenTrace.csproj -c Release -r ${{ matrix.runtime }} \
          --self-contained -o ./output/ -p:SignApp=False -f net8.0

    - name: Download Nexttrace
      uses: robinraju/release-downloader@v1.8
      with:
        repository: nxtrace/NTrace-V1
        fileName: ${{ matrix.nt_file }}
        latest: ${{ github.event.inputs.nexttrace_version == '' }}
        tag: ${{ github.event.inputs.nexttrace_version }}
        token: ${{ secrets.GITHUB_TOKEN }}
        out-file-path: output/OpenTrace.app/Contents/MacOS/

    - name: Setup Nexttrace Binary
      run: |
        mv output/OpenTrace.app/Contents/MacOS/${{ matrix.nt_file }} output/OpenTrace.app/Contents/MacOS/nexttrace
        chmod +x output/OpenTrace.app/Contents/MacOS/nexttrace
        codesign --force --options runtime --timestamp \
          --sign "${{ secrets.MAC_SIGNING_IDENTITY }}" \
          output/OpenTrace.app/Contents/MacOS/nexttrace

    - name: Signing and Notarization
      run: |
        dotnet build OpenTrace.csproj -c Release -r ${{ matrix.runtime }} -o ./output/ \
          -p:SignApp=True -p:MakeDmg=True -p:NotarizeApp=True \
          -p:EnableNotarizationStapler=False \
          -p:MAC_SIGNING_IDENTITY="${{ secrets.MAC_SIGNING_IDENTITY }}"

    - name: Upload Release Asset
      if: github.event_name == 'release'
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: output/OpenTrace.dmg
        asset_name: ${{ matrix.runtime }}.dmg
        tag: ${{ github.ref }}

    # 步骤 7b: 上传Artifact
    - name: Upload Artifact (when manually triggered)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.runtime }}.dmg
        path: output/OpenTrace.dmg